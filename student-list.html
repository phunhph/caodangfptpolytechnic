<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Điểm danh</title>
    <link
      rel="stylesheet"
      href="./bootstrap-5.0.2-dist/css/bootstrap.min.css"
    />
    <style>
      body {
        padding: 20px;
      }
      .table {
        border: none;
      }
      .table thead th {
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
      }
      .table thead {
        background-color: rgb(199, 197, 197);
      }
      .table tbody tr td {
        border: none;
      }
      .table tbody tr td button {
        border: 1px solid #007bff;
      }
      .table tr {
        border-bottom: solid 1px rgb(199, 197, 197);
       text-align: center;
       margin: 0 auto;
      }
      .btn {
        padding: 5px 10px;
      }
      .attendance-btn {
        color: white;
      }
      .not-attended {
        background-color: red;
      }
      .attended {
        background-color: green;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Bảng điều khiển</h2>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Tên Lớp</th>
              <th>Mã Sinh Viên</th>
              <th>Tên Sinh viên</th>
              <th>Ảnh</th>
              <th>Trạng thái</th>
              <th style="width: 30%">Ghi chú</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- Dữ liệu sẽ được thêm vào đây -->
          </tbody>
        </table>
      </div>
      <button id="submitAttendance" class="btn btn-success w-100">
        Lưu điểm danh
      </button>
    </div>
    <script src="bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const apiUrl = "http://localhost:3000/api/students";

      // Hàm để tải dữ liệu sinh viên
      const loadStudents = async () => {
        const response = await fetch(apiUrl);
        const data = await response.json();
        const studentTableBody = document.getElementById("studentTableBody");

        data.forEach((student, index) => {
          const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.class}</td>
                        <td>${student.mssv}</td>
                        <td>${student.name}</td>
                        <td><img src="" alt="Avatar" class="img-thumbnail"></td>
                        <td>
                            <button class="btn attendance-btn ${
                              student.status ? "attended" : "not-attended"
                            }" data-id="${student.mssv}">
                                ${
                                  student.status
                                    ? "Đã điểm danh"
                                    : "Chưa điểm danh"
                                }
                            </button>
                        </td>
                        <td> <input style="width: 100%;" type="text" id="note_${
                          student.mssv
                        }" value="${student.note || ""}"></td>
                    </tr>
                `;
          studentTableBody.insertAdjacentHTML("beforeend", row);
        });

        // Gắn sự kiện cho các nút điểm danh
        document.querySelectorAll(".attendance-btn").forEach((button) => {
          button.addEventListener("click", function () {
            this.classList.toggle("attended");
            this.classList.toggle("not-attended");
            this.textContent = this.classList.contains("attended")
              ? "Đã điểm danh"
              : "Chưa điểm danh";
          });
        });
      };

      // Hàm để xử lý submit điểm danh
      const submitAttendance = async () => {
        const attendanceData = [];
        document.querySelectorAll(".attendance-btn").forEach((button) => {
          const studentId = button.getAttribute("data-id");
          const status = button.classList.contains("attended");
          const note = document.getElementById("note_" + studentId).value;
         
          attendanceData.push({
            mssv: studentId,
            status: status,
            note: note,
          });
        });

        // Gửi dữ liệu điểm danh đến server
        const response = await fetch(`${apiUrl}/attendance`, {
          // Gọi endpoint mới
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(attendanceData),
        });

        if (response.ok) {
          alert("Trạng thái điểm danh đã được cập nhật!"); // Thông báo thành công
        } else {
          alert("Có lỗi xảy ra khi cập nhật trạng thái điểm danh!");
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        loadStudents();
        document
          .getElementById("submitAttendance")
          .addEventListener("click", submitAttendance);
      });
    </script>
  </body>
</html>
